{% comment %}
  EVCC Solar Charging - Full Layout (800x480)
  Terminus/BYOS adapted template
  Polled data is merged directly into template context at top level
{% endcomment %}
{% assign show_energy = "yes" %}
{% assign show_battery = "yes" %}
{% assign show_loadpoints = "yes" %}
{% assign max_lps = 2 %}
{% assign show_vehicle = "yes" %}
{% assign show_stats = "no" %}
{% assign show_tariff = "no" %}

{% comment %} Polled data is merged directly into template context (not under extension.values) {% endcomment %}
{% comment %} energy, battery, loadpoints, statistics are top-level variables {% endcomment %}
{% assign stats = statistics %}

{% comment %} SVG Icons {% endcomment %}
{%- capture icon_sun -%}<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>{%- endcapture -%}
{%- capture icon_grid -%}<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18.36 6.64a9 9 0 1 1-12.73 0"/><line x1="12" y1="2" x2="12" y2="12"/></svg>{%- endcapture -%}
{%- capture icon_home -%}<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>{%- endcapture -%}
{%- capture icon_battery -%}<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="6" width="18" height="12" rx="2" ry="2"/><line x1="23" y1="13" x2="23" y2="11"/></svg>{%- endcapture -%}
{%- capture icon_zap -%}<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>{%- endcapture -%}
{%- capture icon_car -%}<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 17h14M5 17a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h1l2-3h8l2 3h1a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2"/><circle cx="7.5" cy="17" r="2"/><circle cx="16.5" cy="17" r="2"/></svg>{%- endcapture -%}
{%- capture icon_clock -%}<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>{%- endcapture -%}
{%- capture icon_leaf -%}<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 8C8 10 5.9 16.17 3.82 21.34L5.71 22l1-2.3A4.49 4.49 0 0 0 8 20c4 0 8.68-3.27 12-11l-3-1z"/><path d="M14 9a2 2 0 1 0 0 0"/></svg>{%- endcapture -%}

<style>
  .evcc-full { display: flex; flex-direction: column; gap: 8px; padding: 12px 16px; height: 430px; box-sizing: border-box; }
  .evcc-card { background: white; border: 3px solid black; border-radius: 8px; padding: 10px 12px; }
  .evcc-mode { font-size: 10px; font-weight: bold; padding: 2px 6px; border: 2px solid black; border-radius: 4px; white-space: nowrap; flex-shrink: 0; text-transform: uppercase; letter-spacing: 0.5px; }
  .evcc-mode--pv { background: black; color: white; }
  .evcc-mode--minpv { background: #666; color: white; border-color: #666; }
</style>

<div class="evcc-full">

  {% comment %} ===== ENERGY + BATTERY INFO CARD ===== {% endcomment %}
  {% if show_energy == "yes" %}
  <div class="evcc-card flex flex--col gap--xsmall no-shrink">
    <div class="flex flex--between flex--center-y">
      <span class="title title--small">Energy</span>
      {% if energy.green_share_home %}
      <span class="flex flex--center-y gap--xsmall text--gray-50">{{ icon_leaf }} {{ energy.green_share_home }}% green</span>
      {% endif %}
    </div>
    <div class="divider"></div>
    <div class="grid grid--cols-2 gap--medium">
      <div class="flex flex--col">
        <div class="flex flex--between flex--center-y">
          <span class="flex flex--center-y gap--xsmall">{{ icon_sun }} Production</span>
          <strong>{{ energy.pv_power_formatted | default: "0 W" }}</strong>
        </div>
        <div class="flex flex--between flex--center-y">
          <span class="flex flex--center-y gap--xsmall">{{ icon_grid }} Grid use</span>
          <strong>{% if energy.grid_import %}{{ energy.grid_power_formatted | default: "0 W" }}{% else %}0 W{% endif %}</strong>
        </div>
        {% if show_battery == "yes" and battery.configured %}
        <div class="flex flex--between flex--center-y">
          <span class="flex flex--center-y gap--xsmall">{{ icon_battery }} Battery {{ battery.soc | default: 0 }}%</span>
          <strong>{{ battery.power_formatted | default: "0 W" }} {% if battery.charging %}&uarr;{% else %}&darr;{% endif %}</strong>
        </div>
        {% endif %}
      </div>
      <div class="flex flex--col">
        <div class="flex flex--between flex--center-y">
          <span class="flex flex--center-y gap--xsmall">{{ icon_home }} Consumption</span>
          <strong>{{ energy.home_power_formatted | default: "0 W" }}</strong>
        </div>
        <div class="flex flex--between flex--center-y">
          <span class="flex flex--center-y gap--xsmall">{{ icon_grid }} Grid export</span>
          <strong>{% unless energy.grid_import %}{{ energy.grid_power_formatted | default: "0 W" }}{% else %}0 W{% endunless %}</strong>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  {% comment %} ===== LOADPOINTS ===== {% endcomment %}
  {% if show_loadpoints == "yes" %}
    {% assign lp_shown = 0 %}
    {% for lp in loadpoints %}
      {% if lp_shown < max_lps %}
        {% if lp.connected %}
        <div class="evcc-card flex flex--col gap--xsmall">
          <div class="flex flex--between flex--center-y">
            <strong>{{ lp.title }}</strong>
            <span class="evcc-mode{% if lp.mode == 'pv' %} evcc-mode--pv{% elsif lp.mode == 'minpv' %} evcc-mode--minpv{% endif %}">{{ lp.mode_label | default: lp.mode }}</span>
          </div>

          {% if lp.charging %}
            <div class="flex flex--center-y gap--small flex--wrap">
              <span class="flex flex--center-y gap--xsmall">{{ icon_zap }} <strong>{{ lp.charge_power_formatted }}</strong></span>
              {% if lp.charged_energy_kwh > 0 %}
              <strong>{{ lp.charged_energy_kwh }} kWh</strong>
              {% endif %}
              {% if lp.charge_duration_formatted != "" %}
              <span class="flex flex--center-y gap--xsmall">{{ icon_clock }} {{ lp.charge_duration_formatted }}</span>
              {% endif %}
            </div>
            {% if lp.session_solar_pct > 0 %}
            <div class="flex flex--center-y gap--small flex--wrap text--gray-50">
              <span class="flex flex--center-y gap--xsmall">{{ icon_leaf }} <strong>{{ lp.session_solar_pct }}%</strong> solar</span>
              {% if lp.charge_remaining_formatted != "" %}
              <span class="flex flex--center-y gap--xsmall">{{ icon_clock }} {{ lp.charge_remaining_formatted }} left</span>
              {% endif %}
            </div>
            {% endif %}

            {% if show_vehicle == "yes" and lp.vehicle_connected %}
            <div class="flex flex--between flex--center-y">
              <span class="flex flex--center-y gap--xsmall">{{ icon_car }} <strong>{{ lp.vehicle_title | default: "Vehicle" }}</strong></span>
              <span>{{ lp.vehicle_soc }}% {% if lp.limit_soc > 0 %}/ {{ lp.limit_soc }}%{% endif %}{% if lp.vehicle_range > 0 %} &middot; {{ lp.vehicle_range }} km{% endif %}</span>
            </div>
            {% if lp.vehicle_soc > 0 and lp.limit_soc > 0 %}
            <div class="progress-bar progress-bar--small">
              <div class="track">
                <div class="fill" style="width: {% assign pct = lp.vehicle_soc | times: 100 | divided_by: lp.limit_soc %}{% if pct > 100 %}100{% else %}{{ pct }}{% endif %}%;"></div>
              </div>
            </div>
            {% endif %}
            {% endif %}

          {% else %}
            <span class="text--gray-50">{{ lp.status | default: "Connected" }}</span>
            {% if show_vehicle == "yes" and lp.vehicle_connected %}
            <div class="flex flex--between flex--center-y">
              <span class="flex flex--center-y gap--xsmall">{{ icon_car }} <strong>{{ lp.vehicle_title | default: "Vehicle" }}</strong></span>
              <span>{{ lp.vehicle_soc }}%{% if lp.vehicle_range > 0 %} &middot; {{ lp.vehicle_range }} km{% endif %}</span>
            </div>
            {% endif %}
          {% endif %}
        </div>
        {% else %}
        <div class="flex flex--center-y gap--small">
          <strong>{{ lp.title }}</strong>
          <span class="evcc-mode{% if lp.mode == 'pv' %} evcc-mode--pv{% elsif lp.mode == 'minpv' %} evcc-mode--minpv{% endif %}">{{ lp.mode_label | default: lp.mode }}</span>
          <span class="text--gray-50">{{ lp.status | default: "Disconnected" }}</span>
        </div>
        {% endif %}
        {% assign lp_shown = lp_shown | plus: 1 %}
      {% endif %}
    {% endfor %}

    {% if loadpoints.size == 0 %}
      <div class="evcc-card flex flex--center">
        <span class="text--gray-50">No loadpoints configured</span>
      </div>
    {% endif %}
  {% endif %}

</div>

<div class="title_bar">
  <span class="title">{{ site_title | default: "EVCC" }}</span>
  <span class="instance">{{ last_updated_local }} {{ timezone }}</span>
</div>
