{% comment %}
  Full Layout (800x480) - EVCC Solar Charging Dashboard
  Displays: Energy overview, battery status, EV charging loadpoints
  Screen: 800x480 1-bit e-ink (TRMNL)
{% endcomment %}

{% assign show_energy = trmnl.plugin_settings.custom_fields_values.show_energy_overview | default: "yes" | downcase %}
{% assign show_battery = trmnl.plugin_settings.custom_fields_values.show_battery | default: "yes" | downcase %}
{% assign show_loadpoints = trmnl.plugin_settings.custom_fields_values.show_loadpoints | default: "yes" | downcase %}
{% assign max_lps = trmnl.plugin_settings.custom_fields_values.max_loadpoints | default: 2 | plus: 0 %}
{% assign show_vehicle = trmnl.plugin_settings.custom_fields_values.show_vehicle_details | default: "yes" | downcase %}
{% assign show_stats = trmnl.plugin_settings.custom_fields_values.show_statistics | default: "no" | downcase %}
{% assign show_tariff = trmnl.plugin_settings.custom_fields_values.show_tariff | default: "no" | downcase %}

{% comment %} SVG Icons (16x16, stroke-based, monochrome) {% endcomment %}
{%- capture icon_solar -%}<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>{%- endcapture -%}
{%- capture icon_grid -%}<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>{%- endcapture -%}
{%- capture icon_home -%}<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>{%- endcapture -%}
{%- capture icon_battery -%}<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="6" width="18" height="12" rx="2" ry="2"/><line x1="23" y1="13" x2="23" y2="11"/></svg>{%- endcapture -%}
{%- capture icon_car -%}<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 17h14M5 17a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h1l2-3h8l2 3h1a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2"/><circle cx="7.5" cy="17" r="2"/><circle cx="16.5" cy="17" r="2"/></svg>{%- endcapture -%}
{%- capture icon_bolt -%}<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>{%- endcapture -%}
{%- capture icon_leaf -%}<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 8C8 10 5.9 16.17 3.82 21.34l1.89.66.95-2.3c.48.17.98.3 1.34.3C19 20 22 3 22 3c-1 2-8 2.25-13 3.25S2 11.5 2 13.5s1.75 3.75 1.75 3.75"/></svg>{%- endcapture -%}
{%- capture icon_clock -%}<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>{%- endcapture -%}

{% comment %} Pre-compute layout flags {% endcomment %}
{% assign has_energy = false %}
{% if show_energy == "yes" %}{% assign has_energy = true %}{% endif %}
{% assign has_battery = false %}
{% if show_battery == "yes" and battery.configured %}{% assign has_battery = true %}{% endif %}
{% assign has_loadpoints = false %}
{% if show_loadpoints == "yes" and loadpoint_count > 0 %}{% assign has_loadpoints = true %}{% endif %}
{% assign has_stats = false %}
{% if show_stats == "yes" and statistics %}{% assign has_stats = true %}{% endif %}

<style>
  .evcc-full { display: flex; flex-direction: column; gap: 8px; padding: 12px 16px; height: 430px; box-sizing: border-box; }
  .evcc-card { background: white; border: 1px solid black; border-radius: 8px; padding: 10px 12px; }
  .evcc-soc-bar { width: 100%; height: 10px; background: #e5e5e5; border: 1px solid #999; overflow: hidden; position: relative; }
  .evcc-soc-fill { height: 100%; background: black; }
  .evcc-soc-limit { position: absolute; top: 0; bottom: 0; width: 2px; background: #666; }
</style>

<div class="evcc-full">

  {% comment %} ===== GENERAL INFO CARD: Energy + Battery ===== {% endcomment %}
  {% if has_energy %}
  <div class="evcc-card flex flex--col gap--xsmall no-shrink">
    <div class="flex flex--between flex--center-y">
      <span class="title title--small">Energy</span>
      {% assign green_share = energy.green_share_home | default: 0 | plus: 0 %}
      {% if green_share > 0 %}
      <span class="label label--small flex flex--center-y gap--xsmall">{{ icon_leaf }} {{ green_share }}% green</span>
      {% endif %}
    </div>
    <div class="divider"></div>
    <div class="grid grid--cols-2 gap--medium">
      <div class="flex flex--col">
        <div class="flex flex--between flex--center-y">
          <span class="label label--small flex flex--center-y gap--xsmall">{{ icon_solar }} Production</span>
          <span class="value value--small">{{ energy.pv_power_formatted | default: "0 W" }}</span>
        </div>
        <div class="flex flex--between flex--center-y">
          <span class="label label--small flex flex--center-y gap--xsmall">{{ icon_grid }} Grid use</span>
          <span class="value value--small">{% if energy.grid_import %}{{ energy.grid_power_formatted | default: "0 W" }}{% else %}0 W{% endif %}</span>
        </div>
        {% if has_battery %}
        <div class="flex flex--between flex--center-y">
          <span class="label label--small flex flex--center-y gap--xsmall">{{ icon_battery }} Battery {{ battery.soc | default: 0 }}%</span>
          <span class="value value--small">{{ battery.power_formatted | default: "0 W" }} {% if battery.charging %}&uarr;{% else %}&darr;{% endif %}</span>
        </div>
        {% endif %}
      </div>
      <div class="flex flex--col">
        <div class="flex flex--between flex--center-y">
          <span class="label label--small flex flex--center-y gap--xsmall">{{ icon_home }} Consumption</span>
          <span class="value value--small">{{ energy.home_power_formatted | default: "0 W" }}</span>
        </div>
        <div class="flex flex--between flex--center-y">
          <span class="label label--small flex flex--center-y gap--xsmall">{{ icon_grid }} Grid export</span>
          <span class="value value--small">{% unless energy.grid_import %}{{ energy.grid_power_formatted | default: "0 W" }}{% else %}0 W{% endunless %}</span>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  {% comment %} ===== LOADPOINTS SECTION ===== {% endcomment %}
  {% if has_loadpoints %}
    {% for lp in loadpoints limit: max_lps %}
    {% if lp.connected %}
    <div class="evcc-card flex flex--col gap--xsmall">
      <div class="flex flex--between flex--center-y">
        <span class="label">{{ lp.title | default: "Loadpoint" }}</span>
        {% assign lp_mode = lp.mode_label | default: lp.mode | default: "off" %}
        <span class="label label--small{% if lp.charging %} label--inverted{% else %} label--outline{% endif %}">{{ lp_mode }}</span>
      </div>

      <span class="description">{{ lp.status | default: "Unknown" }}</span>

      {% if show_vehicle == "yes" and lp.vehicle_connected %}
        {% if lp.vehicle_title %}
        <div class="flex flex--between flex--center-y">
          <span class="label flex flex--center-y gap--xsmall">{{ icon_car }} {{ lp.vehicle_title }}</span>
          {% if lp.vehicle_range %}<span class="value value--small">{{ lp.vehicle_range }} km</span>{% endif %}
        </div>
        {% endif %}

        {% if lp.vehicle_soc %}
        {% assign v_soc = lp.vehicle_soc | default: 0 | plus: 0 | round: 0 %}
        {% assign l_soc = lp.limit_soc | plus: 0 %}
        <div class="evcc-soc-bar">
          <div class="evcc-soc-fill" style="width: {{ v_soc }}%;"></div>
          {% if l_soc > 0 and l_soc < 100 %}
          <div class="evcc-soc-limit" style="left: {{ l_soc }}%;"></div>
          {% endif %}
        </div>
        <div class="flex flex--between">
          <span class="value value--small">{{ v_soc }}%</span>
          {% if l_soc > 0 and l_soc < 100 %}<span class="description">Limit: {{ l_soc }}%</span>{% endif %}
        </div>
        {% endif %}
      {% endif %}

      {% assign charged_kwh = lp.charged_energy_kwh | default: 0 | plus: 0.0 %}
      {% if lp.charging or charged_kwh > 0 %}
      <div class="flex flex--between flex--center-y">
        <span class="flex flex--center-y gap--xsmall">{{ icon_bolt }} {% if lp.charging %}<span class="value value--small">{{ lp.charge_power_formatted | default: "0 W" }}</span>{% endif %}</span>
        <span class="flex flex--center-y gap--xsmall">
          <span class="value value--small">{{ charged_kwh | round: 1 }} kWh</span>
          {% if lp.charge_duration_formatted %}<span class="description">&middot; {{ lp.charge_duration_formatted }}</span>{% endif %}
        </span>
      </div>

      <div class="flex flex--between flex--center-y">
        {% assign solar_pct = lp.session_solar_pct | default: 0 | plus: 0 %}
        <span class="label label--small flex flex--center-y gap--xsmall">{{ icon_leaf }} {{ solar_pct }}% solar</span>
        {% if lp.session_price %}
        <span class="description">{{ lp.session_price | round: 2 }} {{ currency | default: "EUR" }}</span>
        {% endif %}
      </div>
      {% endif %}

      {% if lp.plan_active and lp.plan_time %}
      <div class="description flex flex--center-y gap--xsmall">{{ icon_clock }} Plan: {{ lp.plan_time }}</div>
      {% endif %}
    </div>
    {% else %}
    <div class="flex flex--center-y gap--small">
      <span class="label">{{ lp.title | default: "Loadpoint" }}</span>
      {% assign lp_mode = lp.mode_label | default: lp.mode | default: "off" %}
      <span class="label label--small label--outline">{{ lp_mode }}</span>
      <span class="description">{{ lp.status | default: "Disconnected" }}</span>
    </div>
    {% endif %}
    {% endfor %}
  {% endif %}

  {% comment %} ===== STATISTICS ROW (optional) ===== {% endcomment %}
  {% if has_stats %}
  <div class="divider"></div>
  <div class="flex flex--center-y gap--medium no-shrink">
    {% if statistics["30d"] %}
    <span class="flex flex--center-y gap--xsmall"><span class="label label--small">30d:</span> <span class="value value--small">{{ statistics["30d"].charged_kwh | default: 0 | round: 0 }} kWh</span></span>
    <span class="description">{{ statistics["30d"].solar_pct | default: 0 | round: 0 }}% solar</span>
    {% if statistics["30d"].avg_price %}
    <span class="description">avg {{ statistics["30d"].avg_price | round: 2 }} {{ currency | default: "EUR" }}/kWh</span>
    {% endif %}
    {% endif %}
    {% if statistics.total %}
    <span class="flex flex--center-y gap--xsmall"><span class="label label--small">Total:</span> <span class="value value--small">{{ statistics.total.charged_kwh | default: 0 | round: 0 }} kWh</span></span>
    <span class="description">{{ statistics.total.solar_pct | default: 0 | round: 0 }}% solar</span>
    {% endif %}
  </div>
  {% endif %}

</div>

{% comment %} ===== TITLE BAR (bottom) ===== {% endcomment %}
<div class="title_bar">
  <span class="title">{{ icon_bolt }} EVCC &mdash; {{ site_title | default: "Solar Charging" }}</span>
  <span class="instance">{{ last_updated_local | default: last_updated }} {{ timezone }}</span>
</div>
