{% comment %}
  Half Horizontal Layout (800x240)
  EVCC Solar Charging - Two-column compact view
  Left: Energy stats (2x2 grid) | Right: First loadpoint summary
{% endcomment %}

{% assign show_energy = trmnl.plugin_settings.custom_fields_values.show_energy_overview | default: "yes" | downcase %}
{% assign show_battery = trmnl.plugin_settings.custom_fields_values.show_battery | default: "yes" | downcase %}
{% assign show_loadpoints = trmnl.plugin_settings.custom_fields_values.show_loadpoints | default: "yes" | downcase %}
{% assign max_lps = trmnl.plugin_settings.custom_fields_values.max_loadpoints | default: 2 | plus: 0 %}
{% assign show_vehicle = trmnl.plugin_settings.custom_fields_values.show_vehicle_details | default: "yes" | downcase %}
{% assign show_stats = trmnl.plugin_settings.custom_fields_values.show_statistics | default: "no" | downcase %}
{% assign show_tariff = trmnl.plugin_settings.custom_fields_values.show_tariff | default: "no" | downcase %}

{% comment %} SVG Icons (14x14 inline) {% endcomment %}
{%- capture icon_solar -%}<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>{%- endcapture -%}
{%- capture icon_grid -%}<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>{%- endcapture -%}
{%- capture icon_home -%}<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>{%- endcapture -%}
{%- capture icon_battery -%}<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="6" width="18" height="12" rx="2" ry="2"/><line x1="23" y1="13" x2="23" y2="11"/></svg>{%- endcapture -%}
{%- capture icon_car -%}<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 17h14M5 17a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h1l2-3h8l2 3h1a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2"/><circle cx="7.5" cy="17" r="2"/><circle cx="16.5" cy="17" r="2"/></svg>{%- endcapture -%}
{%- capture icon_leaf -%}<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 8C8 10 5.9 16.17 3.82 21.34L5.71 22l1-2.3A4.49 4.49 0 0 0 8 20c4 0 8.68-3.9 12-12"/><path d="M2 2s7.45 3.89 8 10"/></svg>{%- endcapture -%}

<style>
  .evcc-half-h {
    display: flex;
    flex-direction: row;
    gap: 10px;
    padding: 10px;
    height: 190px;
    box-sizing: border-box;
  }
  .evcc-half-h .evcc-col--energy {
    width: 370px;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    gap: 6px;
    overflow: hidden;
  }
  .evcc-half-h .evcc-col--loadpoint {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    gap: 6px;
    overflow: hidden;
  }
  .evcc-half-h .evcc-card {
    background: white;
    border: 2px solid black;
    border-radius: 6px;
    padding: 8px;
    display: flex;
    flex-direction: column;
    gap: 4px;
    overflow: hidden;
    height: 100%;
  }
  .evcc-half-h .evcc-energy-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 6px;
    flex: 1;
  }
  .evcc-half-h .evcc-stat-box {
    border: 1px solid black;
    border-radius: 4px;
    padding: 6px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 2px;
  }
  .evcc-half-h .evcc-stat-icon {
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .evcc-half-h .evcc-stat-value {
    font-family: 'DepartureMono', monospace;
    font-size: 16px;
    font-weight: bold;
    line-height: 1;
  }
  .evcc-half-h .evcc-stat-label {
    font-family: 'DepartureMono', monospace;
    font-size: 8px;
    color: #333;
  }
  .evcc-half-h .evcc-lp-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 4px;
    border-bottom: 1px dashed #ccc;
  }
  .evcc-half-h .evcc-lp-title {
    font-family: 'DepartureMono', monospace;
    font-size: 13px;
    font-weight: bold;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .evcc-half-h .evcc-badge {
    font-family: 'DepartureMono', monospace;
    font-size: 10px;
    background: #e5e5e5;
    padding: 1px 5px;
    border-radius: 3px;
    white-space: nowrap;
  }
  .evcc-half-h .evcc-badge--active {
    background: black;
    color: white;
  }
  .evcc-half-h .evcc-lp-content {
    display: flex;
    flex-direction: column;
    gap: 4px;
    flex: 1;
    justify-content: flex-start;
  }
  .evcc-half-h .evcc-vehicle-row {
    display: flex;
    align-items: center;
    gap: 6px;
    font-family: 'DepartureMono', monospace;
    font-size: 11px;
  }
  .evcc-half-h .evcc-vehicle-name {
    font-weight: bold;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .evcc-half-h .evcc-soc-bar {
    flex: 1;
    height: 8px;
    background: #e5e5e5;
    border-radius: 4px;
    border: 1px solid black;
    overflow: hidden;
  }
  .evcc-half-h .evcc-soc-fill {
    height: 100%;
    background: black;
    border-radius: 3px;
  }
  .evcc-half-h .evcc-soc-label {
    font-family: 'DepartureMono', monospace;
    font-size: 10px;
    white-space: nowrap;
  }
  .evcc-half-h .evcc-status-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-family: 'DepartureMono', monospace;
    font-size: 10px;
    color: #333;
  }
  .evcc-half-h .evcc-charge-power {
    font-weight: bold;
    color: black;
  }
  .evcc-half-h .evcc-empty {
    font-family: 'DepartureMono', monospace;
    font-size: 10px;
    color: #666;
    text-align: center;
  }
</style>

<div class="evcc-half-h">

  <!-- Left Column: Energy Stats (2x2 grid) -->
  {% if show_energy == "yes" %}
  <div class="evcc-col--energy">
    <div class="evcc-card">
      <div class="evcc-energy-grid">
        <div class="evcc-stat-box">
          <span class="evcc-stat-icon">{{ icon_solar }}</span>
          <span class="evcc-stat-value">{{ energy.pv_power_formatted | default: "--" }}</span>
          <span class="evcc-stat-label">Solar</span>
        </div>
        <div class="evcc-stat-box">
          <span class="evcc-stat-icon">{{ icon_grid }}</span>
          <span class="evcc-stat-value">{{ energy.grid_power_formatted | default: "--" }}</span>
          <span class="evcc-stat-label">Grid{% if energy.grid_import %} (Import){% else %} (Export){% endif %}</span>
        </div>
        <div class="evcc-stat-box">
          <span class="evcc-stat-icon">{{ icon_home }}</span>
          <span class="evcc-stat-value">{{ energy.home_power_formatted | default: "--" }}</span>
          <span class="evcc-stat-label">Home</span>
        </div>
        {% if show_battery == "yes" and battery.configured %}
        <div class="evcc-stat-box">
          <span class="evcc-stat-icon">{{ icon_battery }}</span>
          <span class="evcc-stat-value">{{ battery.soc | default: 0 }}%</span>
          <span class="evcc-stat-label">Battery{% if battery.power_formatted %} {{ battery.power_formatted }}{% endif %}</span>
        </div>
        {% else %}
        <div class="evcc-stat-box">
          <span class="evcc-stat-icon">{{ icon_leaf }}</span>
          <span class="evcc-stat-value">{{ energy.green_share_home | default: 0 }}%</span>
          <span class="evcc-stat-label">Green</span>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Right Column: First Loadpoint -->
  {% if show_loadpoints == "yes" %}
  <div class="evcc-col--loadpoint">
    <div class="evcc-card">
      {% if loadpoints and loadpoints.size > 0 %}
        {% assign lp = loadpoints | first %}
        <div class="evcc-lp-header">
          <span class="evcc-lp-title">{{ lp.title | default: "Loadpoint" }}</span>
          <span class="evcc-badge{% if lp.charging %} evcc-badge--active{% endif %}">{{ lp.mode_label | default: "off" }}</span>
        </div>
        <div class="evcc-lp-content">
          {% if show_vehicle == "yes" and lp.connected %}
          <div class="evcc-vehicle-row">
            <span class="evcc-stat-icon">{{ icon_car }}</span>
            <span class="evcc-vehicle-name">{{ lp.vehicle_title | default: "Vehicle" }}</span>
            {% if lp.vehicle_soc %}
            <div class="evcc-soc-bar">
              <div class="evcc-soc-fill" style="width: {{ lp.vehicle_soc }}%;"></div>
            </div>
            <span class="evcc-soc-label">{{ lp.vehicle_soc }}%{% if lp.limit_soc %}/{{ lp.limit_soc }}%{% endif %}</span>
            {% endif %}
          </div>
          {% endif %}
          <div class="evcc-status-row">
            <span>{{ lp.status | default: "Disconnected" }}</span>
            {% if lp.charging %}
              <span class="evcc-charge-power">{{ lp.charge_power_formatted | default: "--" }}</span>
            {% endif %}
          </div>
          {% if lp.charging and lp.charged_energy_kwh %}
          <div class="evcc-status-row">
            <span>Session: {{ lp.charged_energy_kwh }} kWh</span>
            {% if lp.session_solar_pct %}
            <span>{{ icon_leaf }} {{ lp.session_solar_pct }}% solar</span>
            {% endif %}
          </div>
          {% endif %}
        </div>
      {% else %}
        <div class="evcc-empty">No loadpoints configured</div>
      {% endif %}
    </div>
  </div>
  {% endif %}

</div>

<div class="title_bar">
  <span class="title">
    {{ icon_solar }} EVCC{% if site_title %} â€” {{ site_title }}{% endif %}
  </span>
  <span class="instance">
    {% if last_updated %}
      {{ last_updated | date: "%s" | plus: trmnl.user.utc_offset | date: "%Y-%m-%d %H:%M" }} {{ timezone }}
    {% else %}
      --:--
    {% endif %}
  </span>
</div>
